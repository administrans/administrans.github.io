<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="bootstrap-3.4.1-dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="custom.css" />
  </head>
  <body>
    <script src="texlive.js/promisejs/promise.js"></script>
    <script src="texlive.js/pdftex.js"></script>
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Trans Administratif</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav">
            
            <li><a href="#procuration/">Courriers par procuration</a></li>
            
            <li><a href="#procuration_relance/">Courriers de relance par procuration</a></li>
            
            <li><a href="#standalone/">Courriers sans procuration</a></li>
            
            <li><a href="#attestation/chgmtprenom/">Changement de pr√©nom</a></li>
          </ul>
          <ul id="memory" class="nav navbar-nav">
            <li><span title="Activer l'enregistrement des donn√©es" class="icon" id="save">üêæÔ∏é</span></li>
            <li><span title="Effacer toutes les donn√©es" class="icon" id="forget">üåäÔ∏é</span></li>
          </ul>
        </div>
      </div>
    </nav>
    <main class="container">
      <div class="container form-container">
        <h1>Nouvelle attestation de changement de pr√©nom <small>G√©n√©ration de la lettre</small></h1>
        <form class="memory form-horizontal">
          <script>
            allFields = [];
            function field(info) {
              var str = '';
              str += '<div class="form-group">';
              str += '  <label class="col-sm-4 control-label" for="'+info.id+'">' + info.label + '</label>';
              str += '  <div class="col-sm-8">';
              if (typeof(info.placeholder) != 'undefined') {
                ph = ' placeholder="' + info.placeholder + '"';
              } else {
                ph = '';
              }
              if (info.type == 'text') {
                str += '    <input class="form-control" type="text" id="' + info.id + '" ' + ph + '/>';
              } else if (info.type == 'date') {
                str += '    <input class="form-control" type="date" id="' + info.id + '" ' + ph + '//>';
              } else if (info.type == 'select') {
                str += '    <select class="form-control" id="' + info.id + '">';
                for (var i = 0; i < info.choices.length; i++) {
                  str += '      <option value="' + info.choices[i][0] + '">' + info.choices[i][1] + '</option>';
                }
                str += '    </select>';
              } else if (info.type == 'checkbox') {
                str += '    <select class="form-control" id="' + info.id + '">';
                str += '      <option value="0">oui</option>';
                str += '      <option value="1">non</option>';
                str += '    </select>';
                /* str += '    <input class="form-control" type="checkbox" id="' + info.id + '" />'; */
              }
              str += '  </div>';
              str += '</div>';
              document.write(str);
              allFields[allFields.length] = info.id;
            }
          </script>
          <fieldset>
            <legend>Informations de la personne trans</legend>
            <script>
              field({ 'type': "text", 'id': "procurantfirstname", 'label': "Pr√©nom (le vrai hein) de la personne trans" });
              field({ 'type': "text", 'id': "procurantlastname", 'label': "Nom de famille de la personne trans" });
              field({ 'type': "text", 'id': "procurantlistofname", 'label': "Liste des pr√©noms (les vrais) de la personne trans", 'placeholder': "√âmilie, Delphine, Coralie" });
              field({ 'type': "date", 'id': "procurantdob", 'label': "Date de naissance de la personne trans" });
              field({ 'type': "text", 'id': "procurantpob", 'label': "Lieu et d√©partement de naissance de la personne trans", 'placeholder': "Nantes (Loire-Atlantique)" });
              field({ 'type': "text", 'id': "procurantaddress1", 'label': "Adresse" });
              field({ 'type': "text", 'id': "procurantaddress2", 'label': "Code postal et Ville" });
              field({ 'type': "select", 'id': "procurantgender", 'label': "Accords de la personne", 'choices': [[0,"f√©minin"], [2,"neutre"], [1,"masculin"]] });
              field({ 'type': "text", 'id': "procurantville", 'label': "Ville dont la personne d√©pend pour l'√âtat-Civil" });
              field({ 'type': "checkbox", 'id': "personignoredeadname", 'label': "La personne faisant l'attestation ignore le deadname" });
              field({ 'type': "text", 'id': "procurantdeadname", 'label': "Deadname de la personne (seulement le pr√©nom) (et seulement si la personne connait le deadname)" });
              field({ 'type': "date", 'id': "date", 'label': "Date de l'attestation" });
            </script>
          </fieldset>
          <fieldset>
            <legend>Informations de la personne qui fait l'attestation</legend>
            <script>
              field({ 'type': "text", 'id': "personfirstname", 'label': "Pr√©nom de la personne qui fait l'attestation" });
              field({ 'type': "text", 'id': "personlastname", 'label': "Nom de famille de la personne qui fait l'attestation" });
              field({ 'type': "text", 'id': "personlistofname", 'label': "Liste des pr√©noms de la personne qui fait l'attestation", 'placeholder': "Corentin, Sebastien, Pierre" });
              field({ 'type': "date", 'id': "persondob", 'label': "Date de naissance de la personne qui fait l'attestation" });
              field({ 'type': "text", 'id': "personpob", 'label': "Lieu et d√©partement de naissance de la personne qui fait l'attestation", 'placeholder': "Nantes (Loire-Atlantique)" });
              field({ 'type': "text", 'id': "persontelephone", 'label': "Num√©ro de t√©l√©phone", 'placeholder': "+33612345678" }); // regex=r'^(\+33|0|0033)\d{9}$',
              field({ 'type': "text", 'id': "personlocation", 'label': "Lieu o√π est faite la lettre" });
              field({ 'type': "text", 'id': "personemail", 'label': "Email de la personne qui fait l'attestation" });
              field({ 'type': "text", 'id': "personaddress1", 'label': "Adresse" });
              field({ 'type': "text", 'id': "personaddress2", 'label': "Code postal et Ville" });
              field({ 'type': "select", 'id': "persongender", 'label': "Accords de la personne", 'choices': [[0,"f√©minin"], [2,"neutre"], [1,"masculin"]] });
            </script>
          </fieldset>
          <div class="form-actions">
            <button id="genpdf-button" class="btn btn-primary" type="submit">G√©n√©rer</button>
          </div>
          <script>
            function logfn(s) {
              if (s !== '') { console.log(s); }
            }
            function utf8Encode(str) {
              try {
                return new TextEncoder().encode(str, 'utf-8').reduce((prev, curr) => prev + String.fromCharCode(curr), '');
              } catch (e) { // no TextEncoder available?
                return unescape(encodeURIComponent(str)); // monsur.hossa.in/2012/07/20/utf-8-in-javascript.html
              }
            }
            function genpdf() {
              fetch("attestation_chgmtprenom.tex").then(res => res.text()).then(function(source_code) {
                source_code = source_code.replaceAll(
                  RegExp("{{- cleaned_data\\[\"(" + allFields.join("|") + ")\"\\] -}}", "g"),
                  function($field$) {
                    //var fieldName = $field$.substring(1, $field$.length-1)
                    var fieldName = $field$.match(/{{- cleaned_data\["([-a-zA-Z0-9]*)"\] -}}/)[1];
                    return document.getElementById(fieldName).value;
                  }
                );
                console.log(source_code);
                var texlive = new TeXLive("texlive.js/");
                texlive.pdftex.set_TOTAL_MEMORY(80*1024*1024).then(function() {
                  texlive.pdftex.on_stdout = logfn;
                  texlive.pdftex.on_stderr = logfn;
                  texlive.pdftex.compile(utf8Encode(source_code)).then(function(pdf_dataurl) {
                    console.log(pdf_dataurl);
                    if (pdf_dataurl === false) {
                      console.log("compilation error");
                    } else {
                      window.open(pdf_dataurl);
                    }
                  });
                });
              });
            }
            document.getElementById("genpdf-button").addEventListener("click", function(e) {
              genpdf();
              e.preventDefault();
            });
          </script>
        </form>
      </div>
    </main>
  </body>
</html>

